
#include <mega16a.h>
#include <delay.h>
#include <string.h>

#define DAT PORTD.4
#define LAT PORTD.5
#define SCK PORTD.6

#define DATA_REGISTER_EMPTY (1<<UDRE)
#define RX_COMPLETE (1<<RXC)
#define FRAMING_ERROR (1<<FE)
#define PARITY_ERROR (1<<UPE)
#define DATA_OVERRUN (1<<DOR)

// BO DEM NHAN DU LIEU UART*************************
#define RX_BUFFER_SIZE 8
char rx_buffer[RX_BUFFER_SIZE];
#if RX_BUFFER_SIZE <= 256
unsigned char rx_wr_index=0,rx_rd_index=0;
#else
unsigned int rx_wr_index=0,rx_rd_index=0;
#endif
#if RX_BUFFER_SIZE < 256
unsigned char rx_counter=0;
#else
unsigned int rx_counter=0;
#endif
//-------------------------------------------------

// KHOI TAO BIEN ********************************************************************** 
bit rx_buffer_overflow;// This flag is set on USART Receiver buffer overflow
flash unsigned char maquet[8]={0xFE,0xFD,0xFB,0xF7,0xEF,0xDF,0xBF,0x7F};
flash unsigned char font[][7]=
{
0x00,0x00,0x00,0x00,0x00,0x00,0x00, //  32
0x10,0x38,0x38,0x10,0x10,0x00,0x10, //! 33
0x6C,0x6C,0x48,0x00,0x00,0x00,0x00, //" 34
0x00,0x28,0x7C,0x28,0x28,0x7C,0x28, //# 35
0x20,0x38,0x40,0x30,0x08,0x70,0x10, //$ 36
0x64,0x64,0x08,0x10,0x20,0x4C,0x4C, //% 37
0x20,0x50,0x50,0x20,0x54,0x48,0x34, //& 38
0x30,0x30,0x20,0x00,0x00,0x00,0x00, //' 39
0x10,0x20,0x20,0x20,0x20,0x20,0x10, //( 40
0x20,0x10,0x10,0x10,0x10,0x10,0x20, //) 41
0x00,0x28,0x38,0x7C,0x38,0x28,0x00, //* 42
0x00,0x10,0x10,0x7C,0x10,0x10,0x00, //+ 43
0x00,0x00,0x00,0x00,0x00,0x30,0x30, //, 44
0x00,0x00,0x00,0x7C,0x00,0x00,0x00, //- 45
0x00,0x00,0x00,0x00,0x00,0x30,0x30, //. 46
0x00,0x04,0x08,0x10,0x20,0x40,0x00, /// 47
0x38,0x44,0x4C,0x54,0x64,0x44,0x38, //0 48
0x10,0x30,0x50,0x10,0x10,0x10,0x38, //1 49
0x38,0x44,0x04,0x18,0x20,0x40,0x7C, //2 50
0x38,0x44,0x04,0x38,0x04,0x44,0x38, //3 51
0x08,0x18,0x28,0x48,0x7C,0x08,0x08, //4 52
0x7C,0x40,0x40,0x78,0x04,0x44,0x38, //5 53
0x18,0x20,0x40,0x78,0x44,0x44,0x38, //6 54
0x7C,0x04,0x08,0x10,0x20,0x20,0x20, //7 55
0x38,0x44,0x44,0x38,0x44,0x44,0x38, //8 56
0x38,0x44,0x44,0x3C,0x04,0x08,0x30, //9 57
0x00,0x00,0x30,0x30,0x00,0x30,0x30, //: 58
0x00,0x00,0x30,0x30,0x00,0x30,0x30, //; 59
0x08,0x10,0x20,0x40,0x20,0x10,0x08, //< 60
0x00,0x00,0x7C,0x00,0x00,0x7C,0x00, //= 61
0x20,0x10,0x08,0x04,0x08,0x10,0x20, //> 62
0x38,0x44,0x04,0x18,0x10,0x00,0x10, //? 63
0x38,0x44,0x5C,0x54,0x5C,0x40,0x38, //@ 64
0x38,0x44,0x44,0x44,0x7C,0x44,0x44, //A 65
0x78,0x44,0x44,0x78,0x44,0x44,0x78, //B 66
0x38,0x44,0x40,0x40,0x40,0x44,0x38, //C 67
0x78,0x44,0x44,0x44,0x44,0x44,0x78, //D 68
0x7C,0x40,0x40,0x78,0x40,0x40,0x7C, //E 69
0x7C,0x40,0x40,0x78,0x40,0x40,0x40, //F 70
0x38,0x44,0x40,0x5C,0x44,0x44,0x3C, //G 71
0x44,0x44,0x44,0x7C,0x44,0x44,0x44, //H 72
0x38,0x10,0x10,0x10,0x10,0x10,0x38, //I 73
0x04,0x04,0x04,0x04,0x44,0x44,0x38, //J 74
0x44,0x48,0x50,0x60,0x50,0x48,0x44, //K 75
0x40,0x40,0x40,0x40,0x40,0x40,0x7C, //L 76
0x44,0x6C,0x54,0x44,0x44,0x44,0x44, //M 77
0x44,0x64,0x54,0x4C,0x44,0x44,0x44, //N 78
0x38,0x44,0x44,0x44,0x44,0x44,0x38, //O 79
0x78,0x44,0x44,0x78,0x40,0x40,0x40, //P 80
0x38,0x44,0x44,0x44,0x54,0x48,0x34, //Q 81
0x78,0x44,0x44,0x78,0x48,0x44,0x44, //R 82
0x38,0x44,0x40,0x38,0x04,0x44,0x38, //S 83
0x7C,0x10,0x10,0x10,0x10,0x10,0x10, //T 84
0x44,0x44,0x44,0x44,0x44,0x44,0x38, //U 85
0x44,0x44,0x44,0x44,0x44,0x28,0x10, //V 86
0x44,0x44,0x54,0x54,0x54,0x54,0x28, //W 87
0x44,0x44,0x28,0x10,0x28,0x44,0x44, //X 88
0x44,0x44,0x44,0x28,0x10,0x10,0x10, //Y 89
0x78,0x08,0x10,0x20,0x40,0x40,0x78, //Z 90
0x38,0x20,0x20,0x20,0x20,0x20,0x38, //[ 91
0x00,0x40,0x20,0x10,0x08,0x04,0x00, //\ 92
0x38,0x08,0x08,0x08,0x08,0x08,0x38, //] 93
0x10,0x28,0x44,0x00,0x00,0x00,0x00, //^ 94
0x00,0x00,0x00,0x00,0x00,0x00,0x7C, //_ 95
0x30,0x30,0x10,0x00,0x00,0x00,0x00, //` 96
0x00,0x00,0x38,0x04,0x3C,0x44,0x3C, //a 97
0x40,0x40,0x78,0x44,0x44,0x44,0x78, //b 98
0x00,0x00,0x38,0x44,0x40,0x44,0x38, //c 99
0x04,0x04,0x3C,0x44,0x44,0x44,0x3C, //d 100
0x00,0x00,0x38,0x44,0x78,0x40,0x38, //e 101
0x18,0x20,0x20,0x78,0x20,0x20,0x20, //f 102
0x00,0x3C,0x44,0x44,0x3C,0x04,0x38, //g 103
0x40,0x40,0x70,0x48,0x48,0x48,0x48, //h 104
0x10,0x00,0x10,0x10,0x10,0x10,0x18, //i 105
0x08,0x00,0x18,0x08,0x08,0x48,0x30, //j 106
0x40,0x40,0x48,0x50,0x60,0x50,0x48, //k 107
0x20,0x20,0x20,0x20,0x20,0x20,0x38, //l 108
0x00,0x00,0x68,0x54,0x54,0x44,0x44, //m 109
0x00,0x00,0x70,0x48,0x48,0x48,0x48, //n 110
0x00,0x00,0x38,0x44,0x44,0x44,0x38, //o 111
0x00,0x78,0x44,0x44,0x44,0x78,0x40, //p 112
0x00,0x3C,0x44,0x44,0x44,0x3C,0x04, //q 113
0x00,0x00,0x58,0x24,0x20,0x20,0x70, //r 114
0x00,0x00,0x38,0x40,0x38,0x04,0x38, //s 115
0x00,0x20,0x78,0x20,0x20,0x28,0x10, //t 116
0x00,0x00,0x48,0x48,0x48,0x58,0x28, //u 117
0x00,0x00,0x44,0x44,0x44,0x28,0x10, //v 118
0x00,0x00,0x44,0x44,0x54,0x7C,0x28, //w 119
0x00,0x00,0x48,0x48,0x30,0x48,0x48, //x 120
0x00,0x48,0x48,0x48,0x38,0x10,0x60, //y 121
0x00,0x00,0x78,0x08,0x30,0x40,0x78, //z 122
0x18,0x20,0x20,0x60,0x20,0x20,0x18, //{ 123
0x10,0x10,0x10,0x10,0x10,0x10,0x10, //| 124
0x30,0x08,0x08,0x0C,0x08,0x08,0x30, //} 125
0x00,0x00,0x28,0x50,0x00,0x00,0x00, //~ 126
};
unsigned char Buffer_display[8][8]=
{
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF
};
unsigned char Buffer_display2[8][8]=
{
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF
};
int MatrixX,MatrixY,p,l;
unsigned char c, buf[50], vt=0, tmp, z=0;
eeprom unsigned char e_buf[50], e_tdd, mode;
eeprom int el;
bit tt=0;
//-------------------------------------------------------------------------------------
#ifndef _DEBUG_TERMINAL_IO_
// HAM NHAN 1 KY TU TU BO DEM UART*****************************************************
#define _ALTERNATE_GETCHAR_
#pragma used+
char getchar(void)
{
char data;
while (rx_counter==0);
data=rx_buffer[rx_rd_index++];
#if RX_BUFFER_SIZE != 256
if (rx_rd_index == RX_BUFFER_SIZE) rx_rd_index=0;
#endif
#asm("cli")
--rx_counter;
#asm("sei")
return data;
}
#pragma used-
#endif
//-------------------------------------------------------------------------------------
// CAC CHUONG TRINH CON*******************************************************
void hc595_out(unsigned char byte)//Xuat du lieu 74hc595
{
    unsigned char i;
    for(i=0;i<8;i++)
    {
        DAT = (byte & (0x80>>i));
        SCK=0;SCK=1;
    }
}

void ledSet(int x,int y,char color)//Bat tat led
{
        if(x>63 || y>7 || x<0 || y < 0)return;
    if(color)Buffer_display[y][x/8]|= (0x80 >> (x%8));
    else Buffer_display[y][x/8] &= ~(0x80 >> (x%8));  
}

void guiKytu(unsigned char txt)//Hien thi font ky tu
{
     int x,y;
    if(6+MatrixX < 0){MatrixX+=6;return;}
     for(y=MatrixY;y<7+MatrixY;y++)
     {
         for(x=MatrixX;x<6 +MatrixX;x++)
         {
             if ( (font[txt-32][y-MatrixY] & (0x80>>(x-MatrixX)))  != 0)
                    ledSet(x,y,0); 
             else   ledSet(x,y,1);
         }
     }
     MatrixX+=6;
}

void guiChuoi(eeprom unsigned char *s)//Hien thi chuoi ky tu
{
    MatrixX=p;
    MatrixY=0;
    while(*s)
        {
            if(MatrixX>63)return;
            guiKytu(*s);         
            s++;
        }
}

void Matrix_update()//Cap nhat bo dem thu 2
{
	unsigned char i,k;
	for(i=0;i<8;i++)
	{
		for(k=0;k<8;k++) Buffer_display2[i][k]=Buffer_display[i][k];
	}
}

void Matrix_Clear()//Xoa du lieu bo dem 1
{
	 unsigned char i,k;
	 for(i=0;i<8;i++)
	 {
       for(k=0;k<8;k++) Buffer_display[i][k]=0xff;
	 }
}

void xoaMang()//Xoa mang   
{
 unsigned char i;
 for(i=0;i<50;i++)
    buf[i] = '\0';
}

void luuEeprom()
{
 unsigned char i;
 for(i=0;i<l;i++)
    e_buf[i] = buf[i];
  el=strlen(buf);   
}

void xoaEeprom()
{
  unsigned char i;
  for(i=0;i<50;i++) e_buf[i]='\0';
}

void kt_speed()
{  
    if(tmp == '1') e_tdd = 25;
    if(tmp == '2') e_tdd = 45;
    if(tmp == '3') e_tdd = 65;
    if(tmp == '4') e_tdd = 85;
    if(tmp == '5') e_tdd = 100;
}

void dichPST()
{
 for(p=63;p>-1*(el*7);p--)
  {
    Matrix_Clear();
	guiChuoi(e_buf);
    Matrix_update();
	delay_ms(e_tdd);
    if(tt) break;
  }
}

void dichTSP()
{
 for(p=-1*(el*7);p<63;p++)
  {
    Matrix_Clear();
	guiChuoi(e_buf);
    Matrix_update();
	delay_ms(e_tdd);
    if(tt) break;
  }
}

void koDich()
{
  p=0;
  Matrix_Clear();
  guiChuoi(e_buf);
  Matrix_update();
}
 
void Hienthi()
{
 kt_speed();
 if(mode=='0')        dichPST();
 else if(mode=='1')   dichTSP();
 else                 koDich();    
}

void Xuly_chuoi()
{
 if(tt)
 {    
    xoaEeprom();
    l = strlen(buf);
    tmp = buf[l-1];
    mode = buf[l-2];
    buf[l-1] = '\0';
    buf[l-2] = '\0';
    luuEeprom();
    tt=0; 
 }
}
//-------------------------------------------------------------------------------------

// HAM NGAT TIMER0 QUET MA TRAN LED**************************************
interrupt [TIM0_OVF] void timer0_ovf_isr(void)
{
 unsigned char i;
 PORTC=0XFF;
 for(i=8;i>0;i--) hc595_out(Buffer_display2[z][i-1]);
 LAT=0;LAT=1;
 PORTC=maquet[z];
 z++;
 if(z>6) z=0;
 TCNT0=0xc8;
}
//-----------------------------------------------------------------------

// HAM NGAT UART NHAN DU LIEU********************************************
interrupt [USART_RXC] void usart_rx_isr(void)
{
char status,data;
status=UCSRA;
data=UDR;
if ((status & (FRAMING_ERROR | PARITY_ERROR | DATA_OVERRUN))==0)
   {
   rx_buffer[rx_wr_index++]=data;
#if RX_BUFFER_SIZE == 256
   // special case for receiver buffer size=256
   if (++rx_counter == 0) rx_buffer_overflow=1;
#else
   if (rx_wr_index == RX_BUFFER_SIZE) rx_wr_index=0;
   if (++rx_counter == RX_BUFFER_SIZE)
      {
      rx_counter=0;
      rx_buffer_overflow=1;
      }
#endif
   }
   c=getchar();
   if(~tt)
    {   
        xoaMang();
        tt=1; vt=0;
        buf[vt]=c;
        vt=1; 
    }
    else
    {   
        buf[vt]=c;
        if(vt<49) vt++;
    }
}
//-----------------------------------------------------------------------

void main()
{
MCUCSR|= (1<<JTD);
//Khoi tao PORTC
DDRC=(1<<DDC7) | (1<<DDC6) | (1<<DDC5) | (1<<DDC4) | (1<<DDC3) | (1<<DDC2) | (1<<DDC1) | (1<<DDC0);
PORTC=(1<<PORTC7) | (1<<PORTC6) | (1<<PORTC5) | (1<<PORTC4) | (1<<PORTC3) | (1<<PORTC2) | (1<<PORTC1) | (1<<PORTC0);
//Khoi tao PORTD
DDRD=(0<<DDD7) | (1<<DDD6) | (1<<DDD5) | (1<<DDD4) | (0<<DDD3) | (0<<DDD2) | (0<<DDD1) | (0<<DDD0);
PORTD=(0<<PORTD7) | (0<<PORTD6) | (0<<PORTD5) | (0<<PORTD4) | (0<<PORTD3) | (0<<PORTD2) | (0<<PORTD1) | (0<<PORTD0);
//Cau hinh Timer0
TCCR0=(0<<WGM00) | (0<<COM01) | (0<<COM00) | (0<<WGM01) | (1<<CS02) | (0<<CS01) | (0<<CS00);
TCNT0=0xc8;
OCR0=0x00;
// Khoi tao ngat Timer
TIMSK=(0<<OCIE2) | (0<<TOIE2) | (0<<TICIE1) | (0<<OCIE1A) | (0<<OCIE1B) | (0<<TOIE1) | (0<<OCIE0) | (1<<TOIE0);
//Cau hinh UART
UCSRA=(0<<RXC) | (0<<TXC) | (0<<UDRE) | (0<<FE) | (0<<DOR) | (0<<UPE) | (0<<U2X) | (0<<MPCM);
UCSRB=(1<<RXCIE) | (0<<TXCIE) | (0<<UDRIE) | (1<<RXEN) | (0<<TXEN) | (0<<UCSZ2) | (0<<RXB8) | (0<<TXB8);
UCSRC=(1<<URSEL) | (0<<UMSEL) | (0<<UPM1) | (0<<UPM0) | (0<<USBS) | (1<<UCSZ1) | (1<<UCSZ0) | (0<<UCPOL);
UBRRH=0x00;
UBRRL=0x33;

// Cho phep ngat toan cuc
#asm("sei")
tt=0;   
while (1)
      {  
        Xuly_chuoi();
        Hienthi();
      }        
}
